<!DOCTYPE html>
<html>
  <head>
    <title>MemberIOO - Charts</title>
    <link rel="stylesheet" href="/libs/jquery/jquery-ui.css">
    <link rel="stylesheet" href="/src/css/main.css" />
    <style>
      .chart {
        width: 100%;
        height: 500px;
      }
    </style>
  </head>
  <body>
    <div class="main bg-gray mx-auto">
      <div class="time-filter flex mb-4">
        <div class="time-filter-label flex items-center mr-4">
          <div>Filter</div>
        </div>
        <div class="flex items-center mr-4">
          <select class="time-filter-code form-control">
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="thisweek">This week</option>
            <option value="lastweek">Last week</option>
            <option value="thismonth">This month</option>
            <option value="lastmonth">Last month</option>
            <option value="all">All Time</option>
            <option value="custom">Custom Date</option>
          </select>
        </div>
        <div class="time-filter-custom" style="display: none;">
          <input type="text" class="datepicker form-control" name="from" />
          <input type="text" class="datepicker form-control" name="to" />
        </div>
      </div>

      <div class="bg-white rounded-md py-6 mx-4 my-6">
        <div class="type-filter flex">
          <div>
            <select class="type-input form-control" data-type="1">
              <option value="leads" selected>Leads</option>
              <option value="visitor">Visitor</option>
              <option value="refunds">Refunds</option>
              <option value="conversion">Conversion</option>
              <option value="revenue">Revenue</option>
              <option value="sales">Sales</option>
            </select>
          </div>
          <div class="flex items-center mx-4">
            <div>vs</div>
          </div>
          <div>
            <select class="type-input form-control" data-type="2">
              <option value="leads">Leads</option>
              <option value="visitor" selected>Visitor</option>
              <option value="refunds">Refunds</option>
              <option value="conversion">Conversion</option>
              <option value="revenue">Revenue</option>
              <option value="sales">Sales</option>
            </select>
          </div>
        </div>

        <div>
          <div id="chart" class="chart"></div>
        </div>
      </div>
      
    </div>
    <script src="/libs/jquery/jquery-1.12.4.js"></script>
    <script src="/libs/jquery/jquery-ui.js"></script>
    <script src="/libs/moment/moment.min.js"></script>
    <script src="/libs/amcharts/core.js"></script>
    <script src="/libs/amcharts/charts.js"></script>
    <script src="/src/js/utils.js"></script>
    <script>
      $(document).ready(function() {
        var timeFilter = {
          code: "today",
          from: moment().format("YYYY-MM-DD"),
          to: moment().format("YYYY-MM-DD")
        };
        var typeFilter = {
          type1: "leads",
          type2: "visitor"
        }
        var chart = undefined;
        var rawChartData = [];
        var chartData = [];
        var am4coreIsReady = false;

        $(".datepicker").datepicker();

        $(".time-filter-code").change(function() {
          timeFilter.code = $(this).val();
          switch (timeFilter.code) {
            case "today":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = moment().format("YYYY-MM-DD");
              timeFilter.to = moment().format("YYYY-MM-DD");
              break;
            case "yesterday":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = moment().subtract(1, 'days').format("YYYY-MM-DD");
              timeFilter.to = moment().subtract(1, 'days').format("YYYY-MM-DD");
              break;
              break;
            case "thisweek":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = moment().startOf('isoWeek').format("YYYY-MM-DD");
              timeFilter.to = moment().format("YYYY-MM-DD");
              break;
              break;
            case "lastweek":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = moment().subtract(1, 'weeks').startOf('isoWeek').format("YYYY-MM-DD");
              timeFilter.to = moment().subtract(1, 'weeks').endOf('isoWeek').format("YYYY-MM-DD");
              break;
              break;
            case "thismonth":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = moment().startOf('month').format("YYYY-MM-DD");
              timeFilter.to = moment().format("YYYY-MM-DD");
              break;
              break;
            case "lastmonth":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = moment().subtract(1, 'month').startOf('month').format("YYYY-MM-DD");
              timeFilter.to = moment().subtract(1, 'month').endOf('month').format("YYYY-MM-DD");
              break;
              break;
            case "all":
              // Hide custom time filter block
              $(".time-filter-custom").css('display', 'none');
              timeFilter.from = "2000-01-01";
              timeFilter.to = moment().format("YYYY-MM-DD");
              break;
              break;
            case "custom":
              // Show time-filter-custom
              $(".time-filter-custom").css('display', 'flex');
              break;
              break;
            default:
              timeFilter.from = moment().format("YYYY-MM-DD");
              timeFilter.to = moment().format("YYYY-MM-DD");
              break;
              break;
          }

          // Redraw chart
          chartData = prepareData(rawChartData, typeFilter, timeFilter);
          drawChart();
        });

        $(".time-filter-custom input[name=from]").change(function() {
          timeFilter.from = $(this).val();
          // Redraw chart
          chartData = prepareData(rawChartData, typeFilter, timeFilter);
          drawChart();
        });

        $(".time-filter-custom input[name=to]").change(function() {
          timeFilter.to = $(this).val();
          // Redraw chart
          chartData = prepareData(rawChartData, typeFilter, timeFilter);
          drawChart();
        });
        
        $(".type-input").change(function() {
          const typeIndex = Number($(this).data("type"));
          if (!isNaN(typeIndex)) {
            typeFilter[`type${typeIndex}`] = $(this).val();
          }

          // Redraw chart
          chartData = prepareData(rawChartData, typeFilter, timeFilter);
          drawChart();
        })

        function prepareData(data, typeFilter, timeFilter) {
          let filteredData = filterData(data, typeFilter, timeFilter);
          console.log("DEBUG filterData");
          console.log(filteredData);
          // sum data
          let arrangedData = arrangeData(filteredData, typeFilter, timeFilter);
          console.log("DEBUG arrangeData");
          console.log(arrangedData);
          //
          return arrangedData;
        }

        function filterData(data, typeFilter, timeFilter) {
          return data.filter(row => {
            return (
              String(row.Type).toUpperCase() === String(typeFilter.type1).toUpperCase()
              || String(row.Type).toUpperCase() === String(typeFilter.type2).toUpperCase()
            ) && (
              moment(timeFilter.from, "YYYY-MM-DD") <= moment(row.Date, "YYYY-MM-DD") 
              && moment(row.Date, "YYYY-MM-DD") <= moment(timeFilter.to, "YYYY-MM-DD")
            ); 
          });
        }

        function arrangeData(data, typeFilter, timeFilter) {
          switch (timeFilter.code) {
            case "today":
              return arrangeDataForToday(data, typeFilter, timeFilter);
            default:
              break;
          }
          return [];
        }

        function initChart(config) {
          am4core.ready(function() {
            am4coreIsReady = true;

            var chart = am4core.create("chart", am4charts.XYChart);

            // chart.data = chartData;
            chart.data = [
              {

              }
            ];

            chart.dateFormatter.inputDateFormat = "yyyy-MM-DD";

            var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
            dateAxis.renderer.minGridDistance = 60;
            dateAxis.startLocation = 0.5;
            dateAxis.endLocation = 0.5;
            dateAxis.baseInterval = {
              timeUnit: "year",
              count: 1
            }

            var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
            valueAxis.tooltip.disabled = true;

            // Configure series1
            var series = chart.series.push(new am4charts.LineSeries());
            series.dataFields.dateX = "year";
            series.name = config.series1.name;
            series.dataFields.valueY = "v1";
            series.tooltipText = "[#000]{valueY.value}[/]";
            series.tooltip.background.fill = am4core.color("#FFF");
            series.tooltip.getStrokeFromObject = true;
            series.tooltip.background.strokeWidth = 3;
            series.tooltip.getFillFromObject = false;
            series.fillOpacity = 0.6;
            series.strokeWidth = 2;
            series.stacked = true;

            // Configure series2
            var series2 = chart.series.push(new am4charts.LineSeries());
            series2.dataFields.dateX = "year";
            series2.name = config.series2.name;
            series2.dataFields.valueY = "v2";
            series2.tooltipText = "[#000]{valueY.value}[/]";
            series2.tooltip.background.fill = am4core.color("#FFF");
            series2.tooltip.getFillFromObject = false;
            series2.tooltip.getStrokeFromObject = true;
            series2.tooltip.background.strokeWidth = 3;
            series2.sequencedInterpolation = true;
            series2.fillOpacity = 0.6;
            series2.stacked = true;
            series2.strokeWidth = 2;

            chart.cursor = new am4charts.XYCursor();
            chart.cursor.xAxis = dateAxis;

            // Add a legend
            chart.legend = new am4charts.Legend();
            chart.legend.position = "top";
            chart.legend.width = 240;
            chart.legend.align = "right";
            chart.legend.data = [{
              "name": config.series1.name,
              "fill": config.series1.marker.fill
            }, {
              "name": config.series2.name,
              "fill": config.series2.marker.fill
            }];
          });
        }

        function drawChart() {
          // if (am4coreIsReady && chart) {
          //   chart.validateData();
          // }
        }

        function loadData() {
          $.ajax({ 
            type: 'GET', 
            url: 'http://localhost:5000/data/data.json', 
            dataType: 'json',
            success: function(response) { 
              rawChartData = response.data;
              chartData = prepareData(rawChartData, typeFilter, timeFilter);
              drawChart();
            }
          });
        }
       
        loadData();
        initChart(
          {
            series1: {
              name: "Leads",
              marker: {
                fill: "#ff0000"
              }
            },
            series2: {
              name: "Visitor",
              marker: {
                fill: "#00ff00"
              }
            }
          }
        );
      });
    </script>
  </body>
</html>